#!/usr/bin/env ruby
# frozen_string_literal: true

# spread — static blog generator
#
# Usage:
#   bin/spread build              # Generate _site/ for deployment
#   bin/spread preview            # Build for local file:// browsing, open in browser
#   bin/spread new "Post title"   # Scaffold a new post
#
# Dependencies: ruby, kramdown (gem)

require 'yaml'
require 'erb'
require 'fileutils'
require 'time'
require 'kramdown'
require 'uri'

SPREAD_ROOT = File.expand_path('..', __dir__)
SITE_DIR    = File.join(SPREAD_ROOT, '_site')
CONTENT_DIR = File.join(SPREAD_ROOT, 'content')
TMPL_DIR    = File.join(SPREAD_ROOT, 'templates')
STATIC_DIR  = File.join(SPREAD_ROOT, 'static')
SITE_URL    = 'https://bioneural.com'
PROD_BASE   = URI.parse(SITE_URL).path.chomp('/')  # '' (root domain)

def log(msg)
  $stderr.puts "spread: #{msg}"
end

# -- Frontmatter parsing --

def parse_file(path)
  raw = File.read(path)
  if raw.start_with?("---\n") || raw.start_with?("---\r\n")
    closing = raw.index("\n---", 3)
    return { meta: {}, body_md: raw } unless closing
    yaml_str = raw[4...closing]
    meta = YAML.safe_load(yaml_str, permitted_classes: [Date, Time]) || {}
    body_md = raw[(closing + 4)..]&.lstrip || ''
  else
    meta = {}
    body_md = raw
  end
  { meta: meta, body_md: body_md }
end

# -- Template rendering --

def load_template(name)
  ERB.new(File.read(File.join(TMPL_DIR, name)))
end

# In deploy mode, base_path is '/spread' (absolute).
# In preview mode, base_path is a relative root like '.', '..', or '../..'.
$base_path = PROD_BASE

def base_path
  $base_path
end

# file:// needs explicit index.html; webservers resolve directories automatically
def idx
  @preview ? 'index.html' : ''
end

def render_layout(page_title:, description: nil, page_url: nil, &block)
  content = block.call
  layout = load_template('layout.html')
  layout.result(binding)
end

def escape_xml(text)
  text.to_s
    .gsub('&', '&amp;')
    .gsub('<', '&lt;')
    .gsub('>', '&gt;')
    .gsub('"', '&quot;')
    .gsub("'", '&apos;')
end

# -- Post loading --

def load_posts
  pattern = File.join(CONTENT_DIR, 'posts', '*.md')
  Dir.glob(pattern).map do |path|
    parsed = parse_file(path)
    meta = parsed[:meta]
    filename = File.basename(path, '.md')
    slug = filename.sub(/\A\d{4}-\d{2}-\d{2}-/, '')
    date = meta['date']
    date = Date.parse(date.to_s) unless date.is_a?(Date)
    {
      title: meta['title'] || slug,
      date: date,
      order: meta['order'] || 0,
      slug: slug,
      description: meta['description'],
      body: Kramdown::Document.new(parsed[:body_md]).to_html,
      path: path
    }
  end.sort_by { |p| [p[:date], p[:order]] }.reverse
end

def load_about
  path = File.join(CONTENT_DIR, 'about.md')
  return nil unless File.exist?(path)
  parsed = parse_file(path)
  { body: Kramdown::Document.new(parsed[:body_md]).to_html }
end

# -- Build --

def build
  log 'building...'

  @build_stamp = Time.now.to_f.to_s

  tmp_dir = "#{SITE_DIR}.tmp"
  FileUtils.rm_rf(tmp_dir)
  FileUtils.mkdir_p(tmp_dir)

  posts = load_posts
  about = load_about

  # Render each post (depth 2: posts/slug/index.html)
  post_tmpl = load_template('post.html')
  posts.each do |post|
    $base_path = @preview ? '../..' : PROD_BASE
    dir = File.join(tmp_dir, 'posts', post[:slug])
    FileUtils.mkdir_p(dir)
    inner = post_tmpl.result(binding)
    html = render_layout(page_title: "#{post[:title]} — spread", description: post[:description], page_url: "#{SITE_URL}/posts/#{post[:slug]}/") { inner }
    File.write(File.join(dir, 'index.html'), html)
  end

  # Render index (depth 0: index.html)
  $base_path = @preview ? '.' : PROD_BASE
  index_tmpl = load_template('index.html')
  inner = index_tmpl.result(binding)
  html = render_layout(page_title: 'spread', description: 'Architecture tradeoffs, debugging paths, and decisions that need room to develop.', page_url: "#{SITE_URL}/") { inner }
  File.write(File.join(tmp_dir, 'index.html'), html)

  # Render about (depth 1: about/index.html)
  if about
    $base_path = @preview ? '..' : PROD_BASE
    about_tmpl = load_template('about.html')
    dir = File.join(tmp_dir, 'about')
    FileUtils.mkdir_p(dir)
    inner = about_tmpl.result(binding)
    html = render_layout(page_title: 'About — spread', page_url: "#{SITE_URL}/about/") { inner }
    File.write(File.join(dir, 'index.html'), html)
  end

  # Generate RSS feed (always uses absolute URLs)
  $base_path = PROD_BASE
  site_url = SITE_URL
  feed_tmpl = load_template('feed.xml')
  feed = feed_tmpl.result(binding)
  File.write(File.join(tmp_dir, 'feed.xml'), feed)

  # Render 404 page (depth 0)
  $base_path = @preview ? '.' : PROD_BASE
  error_tmpl = load_template('404.html')
  inner = error_tmpl.result(binding)
  html = render_layout(page_title: '404 — spread') { inner }
  File.write(File.join(tmp_dir, '404.html'), html)

  # Copy static assets
  Dir.glob(File.join(STATIC_DIR, '**', '*')).each do |src|
    next if File.directory?(src)
    rel = src.sub("#{STATIC_DIR}/", '')
    dest = File.join(tmp_dir, rel)
    FileUtils.mkdir_p(File.dirname(dest))
    FileUtils.cp(src, dest)
  end

  # Copy CNAME for GitHub Pages custom domain
  cname = File.join(SPREAD_ROOT, 'CNAME')
  FileUtils.cp(cname, tmp_dir) if File.exist?(cname)

  # Write build timestamp for hot-reload polling
  File.write(File.join(tmp_dir, '.build'), @build_stamp) if @preview

  # Atomic swap
  old_dir = "#{SITE_DIR}.old"
  FileUtils.rm_rf(old_dir)
  File.rename(SITE_DIR, old_dir) if File.exist?(SITE_DIR)
  File.rename(tmp_dir, SITE_DIR)
  FileUtils.rm_rf(old_dir)

  log "built → #{SITE_DIR}/"
end

# -- Local build --

def local_build
  @preview = true
  build
end

# -- Preview --

def preview
  @preview = true
  build
  index = File.join(SITE_DIR, 'index.html')
  system('open', index)
  log "opened #{index}"
  log "pages auto-refresh every 2s — run 'bin/spread build local' after edits"
end

# -- New post --

def new_post(title)
  slug = title.downcase.strip.gsub(/[^a-z0-9]+/, '-').gsub(/\A-|-\z/, '')
  date = Time.now.strftime('%Y-%m-%d')
  filename = "#{date}-#{slug}.md"
  path = File.join(CONTENT_DIR, 'posts', filename)

  if File.exist?(path)
    log "already exists: #{path}"
    exit 1
  end

  File.write(path, <<~MD)
    ---
    title: "#{title}"
    date: #{date}
    description: ""
    ---

  MD

  log "created #{path}"
end

# -- Entry --

case ARGV[0]
when 'build'
  if ARGV[1] == 'local'
    local_build
  else
    build
  end
when 'preview'
  preview
when 'new'
  title = ARGV[1]
  unless title && !title.empty?
    $stderr.puts 'usage: bin/spread new "Post title"'
    exit 1
  end
  new_post(title)
else
  $stderr.puts 'usage: bin/spread [build|preview|new "title"]'
  exit 1
end
